<body>
	<!-- this section is recognized as e4x for loader.js -->
	<script type="application/javascript">//<![CDATA[
		var event = document.createEvent('DataContainerEvent');
		event.initEvent('OpenConfig', true, false);
		event.setData('caller', location.href);
		document.dispatchEvent(event);
		window.setTimeout('window.close();', 0);
	//]]></script>
</body>

/**
 * @fileOverview Configuration dialog module for restartless addons
 * @author       SHIMODA "Piro" Hiroshi
 * @version      1
 *
 * @license
 *   The MIT License, Copyright (c) 2011 SHIMODA "Piro" Hiroshi.
 *   http://www.cozmixng.org/repos/piro/restartless-addon/trunk/license.txt
 * @url http://www.cozmixng.org/repos/piro/restartless-addon/trunk/
 */

load('WindowManager');
load('prefs');

const EXPORTED_SYMBOLS = ['config'];

const CONFIG_EVENT = 'OpenConfig';
const TYPE_BROWSER = 'navigator:browser';

/**
 * @class
 *   Provides features to manage custom configuration dialog.
 */
var config = {
	_configs : [],

	/**
	 * Opens a registered dialog bound to the given URI as a "non-modal"
	 * window. If there is existing window, then focus to it.
	 *
	 * @param {String} aURI
	 *   A URI which is bould to any configuration dialog.
	 *
	 * @returns {nsIDOMWindow}
	 *   The window object of the configuration dialog.
	 */
	open : function(aURI)
	{
		if (!(aURI in this._configs))
			return null;

		var current = this._configs[aURI];

		if (current.openedWindow && !current.openedWindow.closed) {
			current.openedWindow.focus();
			return current.openedWindow;
		}

		current.openedWindow = Cc['@mozilla.org/embedcomp/window-watcher;1']
							.getService(Ci.nsIWindowWatcher)
							.openWindow(
								null,
								'data:application/vnd.mozilla.xul+xml,'+encodeURIComponent(
									'<?xml version="1.0"?>\n'+
									'<?xml-stylesheet href="chrome://global/skin/"?>\n'+
									current.source
								),
								'_blank',
								'chrome,titlebar,toolbar,centerscreen' +
								(prefs.getPref('browser.preferences.instantApply') ?
									',dialog=no' :
									''// ',modal'
								),
								null
							);
		current.openedWindow.addEventListener('load', function() {
			current.openedWindow.removeEventListener('load', arguments.callee, false);
			current.openedWindow._sourceURI = aURI;
			current.openedWindow.addEventListener('unload', function() {
				current.openedWindow.removeEventListener('unload', arguments.callee, false);
				current.openedWindow = null;
			}, false);
		}, false);
		return current.openedWindow;
	},

	/**
	 * Registers a source code of a XUL document for a configuration dialog
	 * to the given URI. It is used by open().
	 *
	 * @param {String} aURI
	 *   A URI which is the target URI. When the URI is loaded in a browser
	 *   window, then this system automatically opens a generated XUL window
	 *   from the source.
	 * @param {String} aSource
	 *   A source code of a XUL document for a configuration dialog. Typical
	 *   headers (<?xml version="1.0"?> and an <?xml-stylesheet?> for the
	 *   default theme) are automatically added.
	 */
	register : function(aURI, aSource)
	{
		this._configs[aURI] = {
			source       : aSource,
			openedWindow : null
		};
	},

	/**
	 * Unregisters a registeed dialog for the given URI.
	 *
	 * @param {String} aURI
	 *   A URI which have a registered dialog.
	 */
	unregister : function(aURI)
	{
		delete this._configs[aURI];
	},

	/**
	 * Unregisters a default value for the preference.
	 *
	 * @param {String} aKey
	 *   A key of preference.
	 * @param {nsIVariant} aValue
	 *   The default value. This must be a string, integer, or boolean.
	 */
	setDefault : function(aKey, aValue)
	{
		prefs.setDefaultPref(aKey, aValue);
	},


	_windows : [],

	handleEvent : function(aEvent)
	{
		switch (aEvent.type)
		{
			case 'DOMContentLoaded':
				this._onNewWindow(aEvent.currentTarget);
				return;

			case 'unload':
				this._onWindowUnload(aEvent.currentTarget);
				return;

			case CONFIG_EVENT:
				let (target = aEvent.currentTarget) {
					let uri = aEvent.getData('caller');
					if (uri in this._configs) {
						if (target.mTabContainer.childNodes.length == 1)
							target.ownerDocument.defaultView.close();
						this.open(uri);
					}
				}
				return;
		}
	},

	_onWindowUnload : function(aWindow)
	{
		this._windows.splice(this._windows.indexOf(aWindow), -1);
		aWindow.removeEventListener('DOMContentLoaded', this, false);
		aWindow.removeEventListener('unload', this, false);
		aWindow.gBrowser.removeEventListener(CONFIG_EVENT, this, true, true);
	},

	_onNewWindow : function(aWindow)
	{
		if (
			(
			aWindow.document.documentElement.getAttribute('windowtype') != TYPE_BROWSER &&
			!this._isConfigWindow(aWindow) // Firefox 3.6
			) ||
			this._windows.indexOf(aWindow) > -1
			)
			return;

		if (this._isConfigWindow(aWindow)) { // Firefox 3.6
			this.open(aWindow.location.href);
		}
		else {
			this._windows.push(aWindow);
			aWindow.gBrowser.addEventListener(CONFIG_EVENT, this, true, true);
			aWindow.addEventListener('unload', this, false);
		}
	},

	_isConfigWindow : function(aWindow) // Firefox 3.6
	{
		return aWindow.location.href in this._configs;
	}
};

WindowManager.getWindows(TYPE_BROWSER).forEach(function(aWindow) {
	config._onNewWindow(aWindow, true);
});
WindowManager.addHandler(config);

function shutdown()
{
	WindowManager.getWindows(null).forEach(function(aWindow) {
		if (aWindow.document.documentElement.getAttribute('windowtype') == TYPE_BROWSER)
			config._onWindowUnload(aWindow);
		else if (aWindow._sourceURI && aWindow._sourceURI in config._configs)
			aWindow.close();
	});
	WindowManager = void(0);
	config._configs = void(0);
	config._windows = void(0);
	config = void(0);
}
